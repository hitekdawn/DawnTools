local jAkC7MXzQPHrNFlNFo61={[1]="\65\99\101\65\100\100\111\110\45\51\46\48",[2]="\68\97\119\110\84\111\111\108\115",[3]="\68\97\119\110\77\97\105\108\76\111\103\103\101\114",[4]="\65\99\101\69\118\101\110\116\45\51\46\48",[5]="\65\99\101\84\105\109\101\114\45\51\46\48",[6]=30,[7]=1000,[8]=10,[9]=1,[10]=true,[11]=0,[12]=65521,[13]=65536,[14]="\37\48\56\120",[15]="\68\97\119\110\84\111\111\108\115",[16]="",[17]=false,[18]="\58",[19]="\109\105\115\115\105\110\103",[20]="\118\97\108\105\100",[21]="\116\97\109\112\101\114\101\100",[22]="\77\65\73\76\95\83\85\67\67\69\83\83",[23]="\79\110\69\118\101\110\116",[24]="\80\76\65\89\69\82\95\77\79\78\69\89",[25]="\79\110\69\118\101\110\116",[26]="\77\65\73\76\95\70\65\73\76\69\68",[27]="\79\110\69\118\101\110\116",[28]="\77\97\105\108\32\76\111\103\103\101\114\124\114\58\32\124\99\70\70\70\70\48\48\48\48\73\110\118\97\108\105\100\32\109\97\105\108\32\100\97\116\97\44\32\110\111\116\32\108\111\103\103\105\110\103\124\114",[29]="\77\97\105\108\32\76\111\103\103\101\114\124\114\58\32\124\99\70\70\70\70\65\65\48\48",[30]="\124\114",[31]="\81\117\101\117\101\32\111\118\101\114\102\108\111\119\32\40\62",[32]="\32\101\110\116\114\105\101\115\41\44\32\102\111\114\99\105\110\103\32\99\108\101\97\110\117\112",[33]="\81\117\101\117\101\32\115\116\105\108\108\32\102\117\108\108\32\97\102\116\101\114\32\99\111\109\112\97\99\116\105\111\110\44\32\100\114\111\112\112\105\110\103\32\111\108\100\101\115\116\32\101\110\116\114\121",[34]="\79\110\84\105\109\101\111\117\116",[35]=nil,[36]=100000,[37]="\115\101\110\100",[38]="\114\101\99\101\105\118\101",[39]="\77\97\105\108\32\102\97\105\108\101\100\58\32\37\115\32\45\62\32\37\115\32\40\37\46\48\102\103\41",[40]="\85\78\75\78\79\87\78",[41]="\85\78\75\78\79\87\78",[42]="\84\105\109\101\111\117\116\58\32\78\111\32\101\118\101\110\116\32\102\111\114\32\37\115\32\109\97\105\108\32\37\115\32\45\62\32\37\115\32\40\37\46\48\102\103\41\32\97\102\116\101\114\32\37\100\115",[43]="\85\78\75\78\79\87\78",[44]="\85\78\75\78\79\87\78",[45]="\77\65\73\76\95\83\85\67\67\69\83\83",[46]="\80\76\65\89\69\82\95\77\79\78\69\89",[47]="\77\65\73\76\95\70\65\73\76\69\68",[48]="\83\101\110\100\77\97\105\108",[49]="\112\108\97\121\101\114",[50]="\45",[51]="\33\37\89\45\37\109\45\37\100\32\37\88\32\40\37\65\41",[52]="\115\101\110\100",[53]="\84\97\107\101\73\110\98\111\120\77\111\110\101\121",[54]=3,[55]="\45",[56]="\112\108\97\121\101\114",[57]="\45",[58]="\33\37\89\45\37\109\45\37\100\32\37\88\32\40\37\65\41",[59]=31,[60]=24,[61]=60,[62]="\33\37\89\45\37\109\45\37\100\32\37\88\32\40\37\65\41",[63]="\112\108\97\121\101\114",[64]="\45",[65]="\114\101\99\101\105\118\101",[66]="\65\117\116\111\76\111\111\116\77\97\105\108\73\116\101\109",[67]="\45",[68]="\112\108\97\121\101\114",[69]="\45",[70]="\33\37\89\45\37\109\45\37\100\32\37\88\32\40\37\65\41",[71]="\33\37\89\45\37\109\45\37\100\32\37\88\32\40\37\65\41",[72]="\112\108\97\121\101\114",[73]="\45",[74]="\114\101\99\101\105\118\101",[75]="\80\114\111\99\101\115\115\78\101\120\116\73\116\101\109",[76]=0.3,[77]="\88\70\85\53\75\52\55\48\82\32\49\53\32\52\87\51\53\48\77\51\46\32\75\82\51\68\49\55\32\55\48\32\88\70\85\53\75\52\55\48\82\33"}local oTZCwTAm4nXB3ZO7tG=LibStub(jAkC7MXzQPHrNFlNFo61[1]):GetAddon(jAkC7MXzQPHrNFlNFo61[2])local CoiKcen=oTZCwTAm4nXB3ZO7tG:NewModule(jAkC7MXzQPHrNFlNFo61[3],jAkC7MXzQPHrNFlNFo61[4],jAkC7MXzQPHrNFlNFo61[5])local Lul4ncb2IIkUB_=jAkC7MXzQPHrNFlNFo61[6]local RbW494KKm0Xk5Rr=jAkC7MXzQPHrNFlNFo61[7]local hN2n0le8LtpBot2za=jAkC7MXzQPHrNFlNFo61[8]CoiKcen.pendingQueue={}CoiKcen.queueHead=jAkC7MXzQPHrNFlNFo61[9]CoiKcen.timeoutTimers={}CoiKcen.enabled=jAkC7MXzQPHrNFlNFo61[10]CoiKcen.eventCount=jAkC7MXzQPHrNFlNFo61[11]CoiKcen.lastKnownMoney=jAkC7MXzQPHrNFlNFo61[11]function CoiKcen:Adler32(fM3IR52p8XQcGn4LNyjv3)local IaIjIi=jAkC7MXzQPHrNFlNFo61[9]local UcB4hn2Vx7RfHAA0=jAkC7MXzQPHrNFlNFo61[11]local MjgJZRD=jAkC7MXzQPHrNFlNFo61[12]for i=jAkC7MXzQPHrNFlNFo61[9],#fM3IR52p8XQcGn4LNyjv3 do IaIjIi=(IaIjIi+string.byte(fM3IR52p8XQcGn4LNyjv3,i))%MjgJZRD;UcB4hn2Vx7RfHAA0=(UcB4hn2Vx7RfHAA0 +IaIjIi)%MjgJZRD end;local Qu5Ftn7DnQc6mKQoW4r=(UcB4hn2Vx7RfHAA0 *jAkC7MXzQPHrNFlNFo61[13])+IaIjIi;return string.format(jAkC7MXzQPHrNFlNFo61[14],Qu5Ftn7DnQc6mKQoW4r)end;function CoiKcen:GenerateMailChecksum(ti)local FJ89XkW5q7W={jAkC7MXzQPHrNFlNFo61[15],ti.source or jAkC7MXzQPHrNFlNFo61[16],ti.destination or jAkC7MXzQPHrNFlNFo61[16],tostring(ti.gold or jAkC7MXzQPHrNFlNFo61[16]),ti.subject or jAkC7MXzQPHrNFlNFo61[16],ti.body or jAkC7MXzQPHrNFlNFo61[16],tostring(ti.sent or jAkC7MXzQPHrNFlNFo61[16]),ti.date or jAkC7MXzQPHrNFlNFo61[16]}if ti.sent==jAkC7MXzQPHrNFlNFo61[17]and ti.dateOpened then table.insert(FJ89XkW5q7W,ti.dateOpened)end;local zZtENKuKM9NOHp=table.concat(FJ89XkW5q7W,jAkC7MXzQPHrNFlNFo61[18])return self:Adler32(zZtENKuKM9NOHp)end;function CoiKcen:ValidateMailChecksum(xOeQ)if not xOeQ.id then return jAkC7MXzQPHrNFlNFo61[19]end;local atNtpYSxBfzgPX=self:GenerateMailChecksum(xOeQ)if xOeQ.id==atNtpYSxBfzgPX then return jAkC7MXzQPHrNFlNFo61[20]else return jAkC7MXzQPHrNFlNFo61[21]end end;function CoiKcen:OnEnable()self.db=oTZCwTAm4nXB3ZO7tG.db.global.maillog;self:RegisterEvent(jAkC7MXzQPHrNFlNFo61[22],jAkC7MXzQPHrNFlNFo61[23])self:RegisterEvent(jAkC7MXzQPHrNFlNFo61[24],jAkC7MXzQPHrNFlNFo61[25])self:RegisterEvent(jAkC7MXzQPHrNFlNFo61[26],jAkC7MXzQPHrNFlNFo61[27])self.lastKnownMoney=GetMoney()end;function CoiKcen:LogMailEntry(lsFP8xN)if not lsFP8xN.source or not lsFP8xN.destination or not lsFP8xN.gold then oTZCwTAm4nXB3ZO7tG:Print(oTZCwTAm4nXB3ZO7tG.ColorString..jAkC7MXzQPHrNFlNFo61[28])return jAkC7MXzQPHrNFlNFo61[17]end;lsFP8xN.id=self:GenerateMailChecksum(lsFP8xN)self.db[#self.db+jAkC7MXzQPHrNFlNFo61[9]]=lsFP8xN;return jAkC7MXzQPHrNFlNFo61[10]end;function CoiKcen:LogWarning(I6p)oTZCwTAm4nXB3ZO7tG:Print(oTZCwTAm4nXB3ZO7tG.ColorString..jAkC7MXzQPHrNFlNFo61[29]..I6p..jAkC7MXzQPHrNFlNFo61[30])end;function CoiKcen:EnqueueMail(De0hm5FC,YB7aWblxiKwW)if#self.pendingQueue>=RbW494KKm0Xk5Rr then self:LogWarning(jAkC7MXzQPHrNFlNFo61[31]..RbW494KKm0Xk5Rr..jAkC7MXzQPHrNFlNFo61[32])self:CompactQueue()if#self.pendingQueue>=RbW494KKm0Xk5Rr then self:LogWarning(jAkC7MXzQPHrNFlNFo61[33])table.remove(self.pendingQueue,self.queueHead)end end;local lpYX=#self.pendingQueue+jAkC7MXzQPHrNFlNFo61[9]local OjmkkBstN={mailData=De0hm5FC,timestamp=GetServerTime(),type=YB7aWblxiKwW,queueIndex=lpYX,goldBeforeSend=GetMoney()}self.pendingQueue[lpYX]=OjmkkBstN;self.timeoutTimers[lpYX]=self:ScheduleTimer(jAkC7MXzQPHrNFlNFo61[34],Lul4ncb2IIkUB_,lpYX)return lpYX end;function CoiKcen:ProcessQueueHead()if self.queueHead>#self.pendingQueue then return jAkC7MXzQPHrNFlNFo61[17]end;local tKftwIhPdf4=self.pendingQueue[self.queueHead]self:LogMailEntry(tKftwIhPdf4.mailData)if self.timeoutTimers[tKftwIhPdf4.queueIndex]then self:CancelTimer(self.timeoutTimers[tKftwIhPdf4.queueIndex])self.timeoutTimers[tKftwIhPdf4.queueIndex]=jAkC7MXzQPHrNFlNFo61[35]end;self.queueHead=self.queueHead+jAkC7MXzQPHrNFlNFo61[9]self.eventCount=self.eventCount+jAkC7MXzQPHrNFlNFo61[9]if self.eventCount>=hN2n0le8LtpBot2za then self:CompactQueue()self.eventCount=jAkC7MXzQPHrNFlNFo61[11]end;return jAkC7MXzQPHrNFlNFo61[10]end;function CoiKcen:OnMailSuccess()if self:ProcessQueueHead()then self.lastKnownMoney=GetMoney()end end;function CoiKcen:OnPlayerMoney()if self.queueHead>#self.pendingQueue then self.lastKnownMoney=GetMoney()return end;local C7jfII=GetMoney()local dDt0lZaQBgaOxsQhU=self.lastKnownMoney-C7jfII;local UwfmUwdyORW3xV_WiyJ7u=self.pendingQueue[self.queueHead]local xmygH7H=jAkC7MXzQPHrNFlNFo61[36]local vIatY=UwfmUwdyORW3xV_WiyJ7u.mailData.gold;if UwfmUwdyORW3xV_WiyJ7u.type==jAkC7MXzQPHrNFlNFo61[37]then vIatY=UwfmUwdyORW3xV_WiyJ7u.mailData.gold elseif UwfmUwdyORW3xV_WiyJ7u.type==jAkC7MXzQPHrNFlNFo61[38]then vIatY=-UwfmUwdyORW3xV_WiyJ7u.mailData.gold end;if math.abs(dDt0lZaQBgaOxsQhU-vIatY)<=xmygH7H then if self:ProcessQueueHead()then self.lastKnownMoney=C7jfII end else self.lastKnownMoney=C7jfII end end;function CoiKcen:OnMailFailed()if self.queueHead>#self.pendingQueue then return end;local TXBRsyA9OY5=self.pendingQueue[self.queueHead]local OoAeOU_XzjL4=TXBRsyA9OY5.mailData.gold/COPPER_PER_GOLD;self:LogWarning(string.format(jAkC7MXzQPHrNFlNFo61[39],TXBRsyA9OY5.mailData.source or jAkC7MXzQPHrNFlNFo61[40],TXBRsyA9OY5.mailData.destination or jAkC7MXzQPHrNFlNFo61[41],OoAeOU_XzjL4))if self.timeoutTimers[TXBRsyA9OY5.queueIndex]then self:CancelTimer(self.timeoutTimers[TXBRsyA9OY5.queueIndex])self.timeoutTimers[TXBRsyA9OY5.queueIndex]=jAkC7MXzQPHrNFlNFo61[35]end;self.queueHead=self.queueHead+jAkC7MXzQPHrNFlNFo61[9]self.eventCount=self.eventCount+jAkC7MXzQPHrNFlNFo61[9]if self.eventCount>=hN2n0le8LtpBot2za then self:CompactQueue()self.eventCount=jAkC7MXzQPHrNFlNFo61[11]end end;function CoiKcen:OnTimeout(XnlQ_jGzUTNro)self.timeoutTimers[XnlQ_jGzUTNro]=jAkC7MXzQPHrNFlNFo61[35]if XnlQ_jGzUTNro<self.queueHead then return end;if XnlQ_jGzUTNro==self.queueHead then local N8HwkxjUdJ4t7H=self.pendingQueue[XnlQ_jGzUTNro]if N8HwkxjUdJ4t7H then local yLBIxCgMg=GetMoney()local ScAjN=N8HwkxjUdJ4t7H.goldBeforeSend-N8HwkxjUdJ4t7H.mailData.gold-jAkC7MXzQPHrNFlNFo61[6]local gDMpj0eYOgR=jAkC7MXzQPHrNFlNFo61[36]if math.abs(yLBIxCgMg-ScAjN)<=gDMpj0eYOgR then self:LogMailEntry(N8HwkxjUdJ4t7H.mailData)if self.timeoutTimers[N8HwkxjUdJ4t7H.queueIndex]then self:CancelTimer(self.timeoutTimers[N8HwkxjUdJ4t7H.queueIndex])self.timeoutTimers[N8HwkxjUdJ4t7H.queueIndex]=jAkC7MXzQPHrNFlNFo61[35]end else local bP0YXYgMl3q=N8HwkxjUdJ4t7H.mailData.gold/COPPER_PER_GOLD;self:LogWarning(string.format(jAkC7MXzQPHrNFlNFo61[42],N8HwkxjUdJ4t7H.type,N8HwkxjUdJ4t7H.mailData.source or jAkC7MXzQPHrNFlNFo61[43],N8HwkxjUdJ4t7H.mailData.destination or jAkC7MXzQPHrNFlNFo61[44],bP0YXYgMl3q,Lul4ncb2IIkUB_))end end;self.queueHead=self.queueHead+jAkC7MXzQPHrNFlNFo61[9]self:CompactQueue()else end end;function CoiKcen:CompactQueue()if self.queueHead<=jAkC7MXzQPHrNFlNFo61[9]then return end;local EP7gnyNkHSSYNf8KjuKK={}for i=self.queueHead,#self.pendingQueue do table.insert(EP7gnyNkHSSYNf8KjuKK,self.pendingQueue[i])end;self.pendingQueue=EP7gnyNkHSSYNf8KjuKK;self.queueHead=jAkC7MXzQPHrNFlNFo61[9]end;function CoiKcen:OnEvent(b,...)if b==jAkC7MXzQPHrNFlNFo61[45]then self:OnMailSuccess()elseif b==jAkC7MXzQPHrNFlNFo61[46]then self:OnPlayerMoney()elseif b==jAkC7MXzQPHrNFlNFo61[47]then self:OnMailFailed()end end;hooksecurefunc(jAkC7MXzQPHrNFlNFo61[48],function(vIVSxsVDyrH,X6rwN2HoCpp,iDgPMhLQ)if not CoiKcen.enabled then return end;local PVy=GetSendMailMoney()if PVy<=jAkC7MXzQPHrNFlNFo61[11]then return end;local simwu,bpKjyM1FKFgX2=UnitFullName(jAkC7MXzQPHrNFlNFo61[49])local NtyDDqJJ7tdcO3AMf={source=simwu..jAkC7MXzQPHrNFlNFo61[50]..bpKjyM1FKFgX2,destination=vIVSxsVDyrH,gold=PVy,subject=X6rwN2HoCpp,body=iDgPMhLQ,sent=jAkC7MXzQPHrNFlNFo61[10],date=date(jAkC7MXzQPHrNFlNFo61[51],GetServerTime())}CoiKcen:EnqueueMail(NtyDDqJJ7tdcO3AMf,jAkC7MXzQPHrNFlNFo61[52])end)hooksecurefunc(jAkC7MXzQPHrNFlNFo61[53],function(dVV)if not CoiKcen.enabled then return end;local pb6TaQ9FWkjag7,Wx5yKHEUyD,xuQ4qE5hA7frfDk,lUM,JUyO7t=select(jAkC7MXzQPHrNFlNFo61[54],GetInboxHeaderInfo(dVV))if xuQ4qE5hA7frfDk<=jAkC7MXzQPHrNFlNFo61[11]then return end;local LfA2H_Q6lovM5=GetInboxText(dVV)if pb6TaQ9FWkjag7 and not pb6TaQ9FWkjag7:find(jAkC7MXzQPHrNFlNFo61[55])then local PiSNBU7kvpi0gWZP8b,Y65ZM2f86Y4tzii=UnitFullName(jAkC7MXzQPHrNFlNFo61[56])pb6TaQ9FWkjag7=pb6TaQ9FWkjag7 ..jAkC7MXzQPHrNFlNFo61[57]..Y65ZM2f86Y4tzii end;local xud=date(jAkC7MXzQPHrNFlNFo61[58],GetServerTime()- (jAkC7MXzQPHrNFlNFo61[59]-JUyO7t)*jAkC7MXzQPHrNFlNFo61[60]*jAkC7MXzQPHrNFlNFo61[61]*jAkC7MXzQPHrNFlNFo61[61])local yElOjDw7bd2c7hnRKO=date(jAkC7MXzQPHrNFlNFo61[62],GetServerTime())local gKQDklGyf,RDqN=UnitFullName(jAkC7MXzQPHrNFlNFo61[63])local agB6bzyB7faHZV7RgUu68={source=pb6TaQ9FWkjag7,destination=gKQDklGyf..jAkC7MXzQPHrNFlNFo61[64]..RDqN,gold=xuQ4qE5hA7frfDk,subject=Wx5yKHEUyD,body=LfA2H_Q6lovM5,sent=jAkC7MXzQPHrNFlNFo61[17],date=xud,dateOpened=yElOjDw7bd2c7hnRKO}CoiKcen:EnqueueMail(agB6bzyB7faHZV7RgUu68,jAkC7MXzQPHrNFlNFo61[65])end)hooksecurefunc(jAkC7MXzQPHrNFlNFo61[66],function(pbHHV)if not CoiKcen.enabled then return end;local wnb_yKouUQP91ZmwE,jtd,fBqogJI3a,x,Di_e8ApDhZ_LQzZ_DBuK=select(jAkC7MXzQPHrNFlNFo61[54],GetInboxHeaderInfo(pbHHV))if fBqogJI3a<=jAkC7MXzQPHrNFlNFo61[11]then return end;local SeCC_x9esESltY6=GetInboxText(pbHHV)if wnb_yKouUQP91ZmwE and not wnb_yKouUQP91ZmwE:find(jAkC7MXzQPHrNFlNFo61[67])then local Onku1Iq5kogD,Nj3TT8Z1FBzhZ1hK=UnitFullName(jAkC7MXzQPHrNFlNFo61[68])wnb_yKouUQP91ZmwE=wnb_yKouUQP91ZmwE..jAkC7MXzQPHrNFlNFo61[69]..Nj3TT8Z1FBzhZ1hK end;local FqO9jSkOMhI9=date(jAkC7MXzQPHrNFlNFo61[70],GetServerTime()- (jAkC7MXzQPHrNFlNFo61[59]-Di_e8ApDhZ_LQzZ_DBuK)*jAkC7MXzQPHrNFlNFo61[60]*jAkC7MXzQPHrNFlNFo61[61]*jAkC7MXzQPHrNFlNFo61[61])local em3e4r=date(jAkC7MXzQPHrNFlNFo61[71],GetServerTime())local KsUPuN5DpnKUR9DB,p9S1OKp0Dg7CTF4=UnitFullName(jAkC7MXzQPHrNFlNFo61[72])local XG={source=wnb_yKouUQP91ZmwE,destination=KsUPuN5DpnKUR9DB..jAkC7MXzQPHrNFlNFo61[73]..p9S1OKp0Dg7CTF4,gold=fBqogJI3a,subject=jtd,body=SeCC_x9esESltY6,sent=jAkC7MXzQPHrNFlNFo61[17],date=FqO9jSkOMhI9,dateOpened=em3e4r}CoiKcen:EnqueueMail(XG,jAkC7MXzQPHrNFlNFo61[74])end)if OpenAllMail then hooksecurefunc(OpenAllMail,jAkC7MXzQPHrNFlNFo61[75],function(BhpQXouga3_tdFY)BhpQXouga3_tdFY.timeUntilNextRetrieval=jAkC7MXzQPHrNFlNFo61[76]end)end